# -*- coding: utf-8 -*-
"""
Spyder Editor

This is a temporary script file.
"""

import pypylon.pylon as py
import matplotlib.pyplot as plt
import numpy as np
import cv2

def open_cameras():
    cameras = []
    factory = py.TlFactory.GetInstance()
    for i in range(len(factory.EnumerateDevices())):
        cam = py.InstantCamera(factory.CreateFirstDevice())

        cam.Close()
        cam.RegisterConfiguration(py.AcquireContinuousConfiguration(),
                                  py.RegistrationMode_ReplaceAll,
                                  py.Cleanup_Delete)
        cam.Open()
        cam.MaxNumBuffer = 50
        cam.StartGrabbing(py.GrabStrategy_LatestImages)
        cameras.append(cam)
        
    print "opened %s cameras" % len(cameras)
    return cameras

def grab_image(icam):
#    icam.GrabOne(100)   

    icam.RetrieveResult(200, py.TimeoutHandling_Return)
    with icam.RetrieveResult(200, py.TimeoutHandling_Return) as result:
        image  = np.asarray(cv2.cvtColor(result.Array, cv2.COLOR_BAYER_BG2BGR))

    return image
    
def plot_image(camno):
    cameras = open_cameras()
    image = grab_image(cameras[camno])
    
    for i in range(len(cameras)):
        cameras[i].Close()   
        
    plt.matshow(image.sum(-1))
    plt.show(image)
    return image